services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: fc26-postgres
    environment:
      POSTGRES_USER: fc26
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: fc26_tracker
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fc26 -d fc26_tracker"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # FC26 Match Tracker App
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fc26-app
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: "postgresql://fc26:${DB_PASSWORD}@db:5432/fc26_tracker"
      SESSION_SECRET: "${SESSION_SECRET}"
    networks:
      - internal
      - traefik-public
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      # HTTPS Router
      - "traefik.http.routers.fc26.rule=Host(`fc.looth.io`)"
      - "traefik.http.routers.fc26.entrypoints=websecure"
      - "traefik.http.routers.fc26.tls.certresolver=leresolver"
      - "traefik.http.routers.fc26.service=fc26"
      - "traefik.http.services.fc26.loadbalancer.server.port=5000"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.fc26-http.rule=Host(`fc.looth.io`)"
      - "traefik.http.routers.fc26-http.entrypoints=web"
      - "traefik.http.routers.fc26-http.middlewares=fc26-redirect-https"
      - "traefik.http.middlewares.fc26-redirect-https.redirectscheme.scheme=https"

networks:
  traefik-public:
    external: true
  internal:
    driver: bridge

volumes:
  postgres_data:
    driver: local
